# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Repository Overview

Hands-On AI (handsonai.info) — the consolidated site for James Gray's AI courses, setup guides, reference content, and practical AI resources. Built with MkDocs Material and deployed to GitHub Pages.

## Repository Structure

- `docs/agentic-building-blocks/` - The six AI building blocks (Prompts, Context, Projects, Skills, Agents, MCP)
- `docs/business-first-ai-framework/` - Three-phase methodology (Discover, Deconstruct, Build)
- `docs/use-cases/` - Six use case primitives (Content Creation, Research, Coding, Data Analysis, Ideation & Strategy, Automation)
- `docs/platforms/` - Platform-specific content (Claude, OpenAI, Gemini, M365 Copilot)
- `docs/use-the-cookbook/` - Three consumption modes: Ask (MCP Server), Build (Plugins), Learn (Courses)
- `docs/use-the-cookbook/ask/` - MCP server connection guides
- `docs/use-the-cookbook/build/` - Plugin marketplace, getting started, plugin detail pages
- `docs/builder-setup/` - Developer tool installation guides (terminal, Git, editor, Claude Code)
- `docs/patterns/` - Reusable patterns and best practices
- `docs/courses/` - Structured course content (builders, leaders)
- `docs/resources/` - Curated resource pages for external PDFs/reports (with local PDF copies in `docs/assets/pdfs/`)
- `docs/blog/` - Blog posts (MkDocs Material blog plugin); posts go in `posts/` subdirectory
- `docs/overrides/main.html` - FAQPage JSON-LD schema injection for AEO
- `docs/_templates/` - Content templates for contributors
- `.claude/agents/` - Claude Code subagent definitions (local/development copies)
- `.claude/skills/` - Claude Code skill definitions (local/development copies)
- `.claude-plugin/marketplace.json` - Plugin marketplace manifest
- `plugins/` - Distributable plugin bundles (agents + skills grouped by theme)
- `mcp-server/migrations/` - Cloudflare D1 schema migrations
- `mcp-server/scripts/analytics-query.ts` - CLI for querying MCP analytics via Cloudflare REST API
- `scripts/` - Wrapper scripts for scheduled subagents
- `outputs/` - Local working directory for agent outputs (gitignored)
- `specs/` - Local working directory for feature specs (gitignored)
- `docs/whats-new.md` - Auto-generated by release notes agent (gitignored, do not edit manually)
- `docs/courses/*/syllabus.md` - Auto-generated by `scripts/generate_syllabi.py` from Notion (gitignored, do not edit manually)
- `docs/courses/*/lessons/` - Auto-generated lesson detail pages from Notion (gitignored, do not edit manually)

## Content Guidelines

- Write for students who may be new to developer tools
- Include screenshots where helpful
- Keep setup guides tool-focused (one tool per doc)
- Link to official documentation rather than duplicating it
- When adding new docs to `docs/`, also update the `nav:` section in `mkdocs.yml`
- Questions pages must include `question` and `short_answer` frontmatter for AEO schema
- Blog posts require `date`, `authors`, and `categories` frontmatter per MkDocs Material blog plugin

## Feature Development Workflow

For non-trivial changes (new pages, structural reorganization, script additions, multi-file updates), follow this workflow. Skip to step 3 for small edits.

### 1. Define — `/feature-spec`

Use `/feature-spec` to create a spec, or write one manually in `specs/` (gitignored). For early-stage ideas, use the `brainstorming` superpowers skill first.

A spec should include: **Summary**, **Motivation**, **Approach**, **Changes**, **Verification**. See `specs/google-analytics.md` for a format example.

**Skip specs for:** Typo fixes, single-page content updates, urgent hotfixes.

### 2. Plan

Use `/feature-dev` for guided development, or outline the plan in `.claude/plans/`.

For docs changes, a plan typically covers: new/modified files in `docs/`, `mkdocs.yml` nav updates, cross-links to existing pages, and redirects for moved pages.

### 3. Implement

- **Content**: Write Markdown in `docs/`, following Content Guidelines above
- **Nav**: Add new pages to the `nav:` section in `mkdocs.yml`
- **Scripts**: Add or modify scripts in `scripts/`
- **Plugins**: Follow the Plugin Marketplace checklist below

### 4. Verify

Run the build to catch errors before committing:

```
mkdocs build --strict
```

This catches broken links, missing nav entries, YAML errors, and template issues. Use `mkdocs serve` for visual spot-checking.

### 5. Review

Use `/review-pr` or `/code-review` for PR review. For code-heavy changes, the `pr-review-toolkit` agents (code-simplifier, silent-failure-hunter, comment-analyzer) can be dispatched via the Task tool.

### 6. Ship — `/commit-push-pr`

Use `/commit-push-pr` to commit, push, and open a PR. CI deploys automatically on merge to `main`.

After shipping, use `/revise-claude-md` to capture any session learnings.

### Slash command quick reference

| Command | Purpose |
|---------|---------|
| `/feature-spec` | Create a feature spec in `specs/` |
| `/feature-dev` | Guided feature development workflow |
| `/commit` | Create a git commit |
| `/commit-push-pr` | Commit, push, and open a PR |
| `/review-pr` | Comprehensive PR review |
| `/code-review` | Code review a PR |
| `/revise-claude-md` | Capture session learnings into CLAUDE.md |

## Plugin Marketplace

The `plugins/` directory contains distributable Claude Code plugins. Each plugin bundles related agents and skills into a themed toolkit that students can install via `/plugin install`.

### Directory layout

- `.claude-plugin/marketplace.json` — Top-level manifest listing all plugins
- `plugins/<plugin-name>/.claude-plugin/plugin.json` — Per-plugin metadata
- `plugins/<plugin-name>/agents/` — Agent `.md` files
- `plugins/<plugin-name>/skills/` — Skill directories (with `SKILL.md` and optional `references/`)

### Keeping `.claude/` and `plugins/` in sync

The `.claude/` directory is the **development/local** copy (used for repo-local scheduling, `claude --agent`, etc.). The `plugins/` directory is the **distributable** copy. When updating:

1. Always edit `.claude/agents/` or `.claude/skills/` first and test locally
2. Copy the updated file to the corresponding `plugins/<plugin-name>/` location
3. Bump versions (see below)

### Adding a new agent or skill to an existing plugin

1. Create/edit the agent `.md` in `.claude/agents/` (or skill in `.claude/skills/`) — test locally
2. Copy into `plugins/<plugin-name>/agents/` (or `skills/`)
3. Bump `version` in `plugins/<plugin-name>/.claude-plugin/plugin.json` (MINOR for new, PATCH for update)
4. Bump `version` for that plugin in `.claude-plugin/marketplace.json`
5. Update the plugin's section on `docs/use-the-cookbook/build/index.md` — add the agent/skill to the table with a link to the detail page anchor
6. Update the plugin's detail page (`docs/use-the-cookbook/build/<plugin-name>.md`) — add the agent/skill section following the existing component format
7. Commit and push

### Creating a new plugin

1. Create and test agents/skills locally in `.claude/agents/` and `.claude/skills/`
2. Create the plugin directory structure:
   ```
   plugins/<new-plugin>/
   ├── .claude-plugin/
   │   └── plugin.json
   ├── agents/
   │   └── <agent>.md
   └── skills/          (if applicable)
       └── <skill>/
           └── SKILL.md
   ```
3. Write `plugin.json` with name, description, version, author, keywords
4. Add a new entry to `.claude-plugin/marketplace.json`
5. Add a grid card + collapsible detail section to `docs/use-the-cookbook/build/index.md` — include links to the detail page anchors for every agent and skill
6. Create a detail page at `docs/use-the-cookbook/build/<plugin-name>.md` following the template used by existing detail pages (see `docs/use-the-cookbook/build/business-first-ai.md` for reference)
7. Add the detail page to the `nav:` section in `mkdocs.yml` under "Use the Cookbook > Build (Plugins)"
8. Commit and push

### Catalog page linking convention

Every agent and skill name in the `docs/use-the-cookbook/build/index.md` tables **must** link to the corresponding section on the plugin's detail page:

- **Agents** → link to the detail page anchor: `[`agent-name`](<plugin-name>.md#<agent-name>)`
- **Skills** → link to the detail page anchor: `[`skill-name`](<plugin-name>.md#<skill-name>)`

This directs users to human-readable documentation instead of raw source code. Every time an agent or skill is added to the marketplace, add both the catalog table entry and the detail page section.

### Versioning convention

- **Semantic versioning**: `MAJOR.MINOR.PATCH`
- Adding a new agent/skill to a plugin = bump MINOR (e.g., 1.0.0 → 1.1.0)
- Updating an existing agent/skill = bump PATCH (e.g., 1.1.0 → 1.1.1)
- Breaking changes (renaming, removing, restructuring) = bump MAJOR

## Adding a PDF Resource

The `docs/resources/` section hosts curated resource pages for external PDFs and reports. Each PDF gets a markdown page (for MCP search indexing) and a local copy (to prevent link rot).

### Adding a new resource

1. Download the PDF to `docs/assets/pdfs/<descriptive-filename>.pdf`
2. Create a resource page at `docs/resources/<slug>.md` with frontmatter (`title`, `description`), source attribution, "Why This Matters" section, "Key Takeaways" bullets, "How the Cookbook Uses This" cross-links, and a download button linking to `../assets/pdfs/<filename>.pdf`
3. Add the page to `docs/resources/index.md` catalog table
4. Add the page to the `nav:` section in `mkdocs.yml` under "Use the Cookbook > Resources"
5. Update any existing pages that linked to the external PDF URL to point to the new resource page instead

The MCP server indexes resource pages automatically — no changes to `build-index.ts` or `tools.ts` needed (the `resources` section mapping is already configured).

## MCP Server Analytics

The MCP server (`mcp-server/`) logs tool calls and resource reads to a Cloudflare D1 database (`handsonai-mcp-analytics`) for content gap analysis. Analytics is non-blocking — failures never affect MCP responses.

### Key files

- `mcp-server/src/analytics.ts` — `logEvent()`, `sanitizeParams()`, `getResultSize()` functions
- `mcp-server/src/index.ts` — `ctx.waitUntil()` instrumentation in the fetch handler
- `mcp-server/src/dashboard.ts` — Analytics dashboard: auth, 11 API endpoints, HTML UI with Chart.js
- `mcp-server/migrations/` — D1 schema migrations (applied via `wrangler d1 migrations apply`)
- `mcp-server/scripts/analytics-query.ts` — CLI for querying analytics (`npm run analytics <command>`)
- `mcp-server/.env.example` — Required env vars for the CLI script
- `docs/use-the-cookbook/ask/index.md` — Privacy disclosure ("Analytics & Privacy" section)

### What's logged

Tool name, sanitized params (query/path only, max 200 chars), result size, error status, duration, User-Agent, and country. Only `tools/call` and `resources/read` methods — protocol handshakes (`initialize`, `ping`, `tools/list`) are excluded. No PII is collected.

### CLI commands

Run from `mcp-server/`: `npm run analytics <command> [--days=N]`

Commands: `top-queries`, `tool-usage`, `daily-volume`, `top-pages`, `errors`, `zero-results`, `clients`, `raw-sql` (SELECT only).

### Adding a new migration

1. Create `mcp-server/migrations/NNNN_description.sql`
2. Apply locally: `wrangler d1 migrations apply handsonai-mcp-analytics --local`
3. Test with `wrangler dev`
4. Apply to production: `wrangler d1 migrations apply handsonai-mcp-analytics --remote`

### Deployment

After changes to `mcp-server/src/`: run `wrangler deploy` from `mcp-server/`. The D1 database ID is in `wrangler.toml` (not a secret).

### Analytics Dashboard

Live at `mcp.handsonai.info/dashboard` (custom domain configured in `wrangler.toml`). Admin-only, cookie-based auth via `ANALYTICS_TOKEN` Worker secret. Visit `/dashboard?token=<token>` once to set cookie, then bookmark `/dashboard`.

For local dev: create `mcp-server/.dev.vars` with `ANALYTICS_TOKEN=<test-value>`, then `wrangler dev`. The `.dev.vars` file is gitignored by Wrangler defaults.

## Scheduling Subagents

When setting up scheduled tasks for subagents:
- Use `claude -p "prompt" --dangerously-skip-permissions` to allow headless tool use (required for agents that write files)
- Use the full path to claude binary (e.g., `~/.local/bin/claude`) since launchd/Task Scheduler have minimal PATH
- Always include logging to capture stdout/stderr for troubleshooting
- Store logs in the project's `logs/scheduled/` folder so they're easy to find
- Include timestamps in log filenames for easy debugging

### Windows-specific
- **Always write PowerShell to `.ps1` files** rather than running inline commands - `$` variables get stripped when passing PowerShell through Git Bash
- Create a runner script (e.g., `scripts/run-<agent-name>.ps1`) and a setup script (e.g., `scripts/setup-<agent-name>-schedule.ps1`)
- Use `Register-ScheduledTask` in the setup script to register with Task Scheduler